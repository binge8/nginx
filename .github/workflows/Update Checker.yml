name: Update Checker

env:
  IMAGE_NAME: nginx:alpine

on:
  repository_dispatch:
    types: Update-Nginx
  workflow_dispatch:
  #schedule:
  #  - cron: 58 15 * * *

jobs:
  check:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@main
      - name: è·å–Hash
        id: getHash
        run: |
          docker pull $IMAGE_NAME
          echo "commitHash=$(docker images -q $IMAGE_NAME )" >> $GITHUB_OUTPUT
      - name: æ¯”è¾ƒHash
        id: cacheHash
        uses: actions/cache@main
        with:
          path: .commitHash
          key: HEAD-${{ steps.getHash.outputs.commitHash }}
      - name: ä¿å­˜Hashï¼Œè®¾ç½®å¾®ä¿¡æ¨é€å˜é‡
        if: ${{ always() }}
        run: |
          if [ "${{steps.cacheHash.outputs.cache-hit}}" = "true" ];then
            echo "STATUS=âœ… Nginxæ— æ›´æ–° | æš‚åœæ„å»º" >> $GITHUB_ENV
          else
            if [ -n "${{ steps.getHash.outputs.commitHash }}" ];then
              echo "STATUS=âœ… Nginxæœ‰æ›´æ–° | å¼€å§‹æ„å»º" >> $GITHUB_ENV
              curl -X POST https://api.github.com/repos/binge8/nginx/dispatches -H "Accept: application/vnd.github.everest-preview+json" -H "Authorization: token ${{ secrets.RELEASES_TOKEN }}" --data '{"event_type": "nginx"}'
              echo ${{ steps.getHash.outputs.commitHash }} | tee .commitHash
            else
              echo "STATUS=âŒ Nginxæ›´æ–°æ£€æµ‹å¤±è´¥" >> $GITHUB_ENV
            fi
          fi
      - name: åˆ é™¤è¿è¡Œè®°å½•
        if: ${{ always() }}
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ secrets.RELEASES_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 5
          keep_minimum_runs: 3
      - name: ä¼ä¸šå¾®ä¿¡åº”ç”¨æ¶ˆæ¯æ¨é€
        if: ${{ always() }}
        env:
          CORP_ID: ${{ secrets.CORP_ID }}
          CORP_SECRET: ${{ secrets.CORP_SECRET }}
          AGENT_ID: ${{ secrets.AGENT_ID }}
          TEXT:  |
            ğŸš€GitHub Action é€šçŸ¥
            
            ä»“åº“: ${{ github.repository }}
            -----------------------------
            ${{ env.STATUS }}
          PROXY_URL: ${{ secrets.PROXY_URL }}  # ä»£ç†ï¼ˆå¯é€‰ï¼‰
        run: |
          wget --no-check-certificate https://ac.cxw28.cn/notify.py && chmod +x notify.py
          python3 notify.py